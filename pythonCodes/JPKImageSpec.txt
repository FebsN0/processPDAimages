.. -*- mode: rst; coding: utf-8 -*-

.. This file is in reStructuredText format.  It can be converted to
   HTML, for example, by typing

       rst2html --input-encoding utf-8 JPKImageSpec.txt JPKImageSpec.html

   This document was formerly named TifSpec.txt.

=====================================
Specification for JPK SPM Image Files
=====================================

:Version: 2.0:3fffffffffff
:Date: 2015-03-31
:Copyright: Copyright Â© JPK BioAFM Business, 2002-2022.  All rights reserved.
:Copies: For copies or updates of this document, please contact `JPK BioAFM`_.
:Email: support@jpk.com

--------
Abstract
--------

This document describes the format currently used for JPK BioAFM
SPM image files.

.. contents:: Table of contents


--------
Overview
--------

The ``*.jpk`` files in which scans are stored conform to the TIFF
standard version 6.0.  See the `TIFF specification
<http://partners.adobe.com/asn/tech/tiff/index.jsp>`_ or the
`unofficial TIFF homepage <http://home.earthlink.net/~ritter/tiff/>`_
for general information about the TIFF standard.  The following
describes how the ``*.jpk`` files use the special features of the TIFF
file format to store scan data from SPM scans.

Each scan file holds multiple images and their corresponding
"directories" of associated information ("image file directories" or
"IFDs" in the TIFF terminology).  Each IFD contains tag-value pairs
describing information about the associated image.  Some of the tags
are required by the TIFF specification itself (for example, the data
format, the width and height of the image, etc.) and some of them are
"private tags" specific to JPK files.  In the TIF-specification, the
tags with values 0x8000 and above are reserved for private use.  JPK
Instruments uses these private tags to store information about the
scan.  Each IFD has a pointer to the following IFD, and in this manner
many images are stored in the file (this technique is described on
page 16 of the TIFF specification).

The first IFD contains many common parameters that apply to all of the
images in the ``*.jpk`` file; for example, the userid of the person
who took the image, information about the feedback mode, the position
and physical dimensions of the spatial grid that was scanned, etc.
The image associated with the first IFD is a small, low-resolution
thumbnail image of one channel (normally "height"), and serves as a
graphical preview of what the file contains.  It is not intended that
the thumbnail be used for further processing or publication.

Each subsequent IFD stores the channel-specific information and the
full-resolution image data for either the trace or the retrace of one
channel.  Channel-specific information includes such things as the
name of the channel, details about its calibration, etc.


---------------
Version numbers
---------------

Starting with FileFormatVersion 2.0, JPK has switched to a
feature-based system for describing the version of a file.  The
FileFormatVersion of all image files will remain at "2.0".  However,
now there is a second number, ``FileFormatFeatures``, that encodes
what additional file features are present in the file.  This tag is
stored as a string that represents a bitmap as a large hexadecimal
integer (e.g., "40008b46").  Each bit in this value indicates a new
feature or new piece of data that is present in the file.  Each
version of the JPK BioAFM software has a similar bitmap
representing the features it is capable of understanding, and it can
therefore determine whether it is able to read a particular file by
checking whether all of the bits in the FileFormatFeatures bitmap are
also set in its own capabilities bitmap.

However, the main structure of the JPK TIFF file format has not
changed in a long time, and most of the new features cover metadata
details that would not be interesting to third-party tools.  (Usually
you would only need to worry about FileFormatFeatures if you want to
be sure that you can read every last iota of file metadata.)  If you
require more details about file format features, please contact `JPK
Instruments`_.


------------
General data
------------

The Thumbnail
=============

The first image contains a thumbnail with a standard view of the
image.  It is a scaled image with the dimensions 64x64, and can be
used, for example, to quickly generate an overview of the files in a
directory.  Typically the thumbnail generated by SPM shows the trace
data for the height channel; DP typically uses the image resulting
from processing.  The IFD for the thumbnail image contains much
information that is common to all of the other images.

Common Information
==================

JPK BioAFM uses private tags in the first IFD to store general
scan data such as date, name, comment, type, company, cantilever-data,
feedback-settings and grid-data.

In the following table, the following abbreviations are used to denote
the type of the field:

+-----------------------------------------------------------+
| Type abbreviations                                        |
+--------------+---------+----------------------------------+
| Abbreviation | Type    | Notes                            |
+==============+=========+==================================+
| d            | double  |                                  |
+--------------+---------+----------------------------------+
| i            | integer |                                  |
+--------------+---------+----------------------------------+
| bool         | boolean | Encoded using unsigned shorts:   |
|              |         | 0 = false; nonzero = true        |
+--------------+---------+----------------------------------+
| str          | String  | Encoded using UTF-8 [#utf]_      |
+--------------+---------+----------------------------------+
| date         | date    | Format: 'yyyy-MM-dd HH:mm:ss zz' |
+--------------+---------+----------------------------------+

.. [#utf] Prior to 2004-01-26, only ASCII characters were supported.

The "required" column specifies whether the field is required ("y"),
not required ("n"), or required only if the condition for this field
is met ("y/n").  For example, if Encoder-Name is LinearScaling, the
fields Scaling-Multiply and Scaling-Offset have to be set.

Tag 0x8001 stores the file version as a double value (an integer would
have been more appropriate).

To be backward compatible there is a workaround for version < 0.15
where the default slot wasn't saved.  Now a second workaround is
written to be backward compatible for version < 0.25 there the
sensitivity and spring constant were saved, but not used (see bug
#1813 for details).

+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Name                               | Tag      | Required | Type | Range, example | Description                                                     |
+====================================+==========+==========+======+================+=================================================================+
| ProgramVersion                     | 0x8000   | n        | str  | e.g. '3.1.6'   | Version of JPKSPM software that created the file.               |
|                                    |          |          |      |                | This tag wasn't written before version 3.1.6                    |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| FileFormatVersion                  | 0x8001   | n        | d    | e.g. 0.3       | Version of TIFF-File, version of this table.                    |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| SavedByProgram                     | 0x8002   | n        | i    | [0;3]          | The program, that generated this file:                          |
|                                    |          |          |      |                | 00=other, 01=SPM, 02=IP, 03=SPIP                                |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| StartDate                          | 0x8003   | n        | str  |                | Start-Date, when Scan was measured or when data were            |
|                                    |          |          |      |                | modified or saved.  Format: 'yyyy-MM-dd HH:mm:ss zz'            |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Name                               | 0x8004   | n        | str  |                | Name of the sample, a name which indicates the specimen         |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Comment                            | 0x8005   | n        | str  |                | A description of the sample being scanned                       |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| EndDate                            | 0x8006   | n        | str  |                | End-Date, when Scan was measured or when data were              |
|                                    |          |          |      |                | modified or saved.  Format: 'yyyy-MM-dd HH:mm:ss zz'            |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Sample                             | 0x8007   | n        | str  |                | Probe info, like a comment                                      |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| UniqueID                           | 0x8008   | n        | str  |                | Identifies every scan in a unique way                           |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| AccountName                        | 0x8009   | n        | str  |                | Account name of the user who stored the scan                    |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Cantilever-Comment                 | 0x8010   | n        | str  |                | Could be used to describe a special coating, etc...             |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Cantilever-SpringConst             | 0x8011   | n        | d    |                | Spring-constant in [N/m]                                        |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Cantilever-Calibrated              | 0x8012   | n        | bool |                | Calibrated is true, if the user has finished a calibration      |
|                                    |          |          |      |                | process or decides that the cantilever is calibrated            |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Cantilever-Shape                   | 0x8013   | n        | str  | 'unknown'      | Today two common shapes are available: rectangular and          |
|                                    |          |          |      | 'rect'         | triangular, not used yet!                                       |
|                                    |          |          |      | 'triang'       |                                                                 |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Cantilever-Radius                  | 0x8014   | n        | d    |                | The cantilever tip-radius in [m]                                |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| ApproachID                         | 0x8015   | n        | str  |                | An identification string that is changed every time the stepper |
|                                    |          |          |      |                | motors are moved                                                |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| FileFormatFeatures                 | 0x8016   | n        | str  |                | Bitmap describing file format features present in this file,    |
|                                    |          |          |      |                | as integer converted to a hexadecimal string.  See section      |
|                                    |          |          |      |                | `Version Numbers`_                                              |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Feedback_Mode                      | 0x8030   | n        | str  | 'contact'      | Identifies the mode in which the data were collected            |
|                                    |          |          |      | 'intermittent' |                                                                 |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Feedback_pGain                     | 0x8031   | n        | d    |                | Proportional gain of the feedback-loop                          |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Feedback_iGain                     | 0x8032   | n        | d    |                | Integral gain of the feedback-loop in Hz                        |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Feedback_Setpoint                  | 0x8033   | n        | d    |                | The setpoint in V                                               |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Feedback_Var[1;5]                  | [0x8034; | n        |varies|                | Parameters describing the feedback mode                         |
|                                    | 0x8038]  |          |      |                |                                                                 |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Feedback_Approach AdjustBaseline   | 0x8034   | n        | i    | Contact mode   |                                                                 |
|                                    |          |          |      | only           |                                                                 |
+------------------------------------+----------+----------+------+                +-----------------------------------------------------------------+
| Feedback_Baseline                  | 0x8035   | n        | d    |                |                                                                 |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Feedback_Adjust ReferenceAmplitude | 0x8034   | n        | i    | Intermittent   |                                                                 |
+------------------------------------+----------+----------+------+ contact mode   +-----------------------------------------------------------------+
| Feedback ReferenceAmplitude        | 0x8035   | n        | d    | only           |                                                                 |
+------------------------------------+----------+----------+------+                +-----------------------------------------------------------------+
| Feedback_Amplitude                 | 0x8036   | n        | d    |                |                                                                 |
+------------------------------------+----------+----------+------+                +-----------------------------------------------------------------+
| Feedback_Frequency                 | 0x8037   | n        | d    |                |                                                                 |
+------------------------------------+----------+----------+------+                +-----------------------------------------------------------------+
| Feedback_Phaseshift                | 0x8038   | n        | d    |                |                                                                 |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Approach_IGain                     | 0x8039   | n        | d    |                |                                                                 |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Approach_PGain                     | 0x803A   | n        | d    |                |                                                                 |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Tipsaver_Setpoint                  | 0x803B   | n        | d    |                |                                                                 |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Tipsaver_Active                    | 0x803C   | n        | b    |                | It is required, if Tipsaver_Setpoint is set.                    |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Tipsaver_LowerLimit                | 0x803D   | n        | b    |                | not saved yet                                                   |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Feedback_Settings_as_Properties    | 0x803E   | n        | str  |                | Contains the textual representation of the feedback-settings    |
|                                    |          |          |      |                | Format is as specified in the java.util.Properties object       |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Grid-x0                            | 0x8040   | y        | d    |                | The x and y coordinates of the (0,0) point of the lattice, in   |
+------------------------------------+----------+----------+------+----------------+ meters measured from the center of the area accessable by the   |
| Grid-y0                            | 0x8041   | y        | d    |                | instrument                                                      |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Grid-uLength                       | 0x8042   | y        | d    |                | Length of the grid in the fast- and slow-directions, [m]        |
+------------------------------------+----------+----------+------+----------------+                                                                 |
| Grid-vLength                       | 0x8043   | y        | d    |                |                                                                 |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Grid-Theta                         | 0x8044   | y        | d    |                | Angle of the fast axis measured relative to the x axis, in      |
|                                    |          |          |      |                | radians                                                         |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Grid-Reflect                       | 0x8045   | y        | bool |                | Is the grid "mirror reflected", making (u,v) a left-handed      |
|                                    |          |          |      |                | coordinate system? (If so, the v axis points in direction       |
|                                    |          |          |      |                | opposite to normal)                                             |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Grid-iLength                       | 0x8046   | y        | i    |                | The number of pixels in the fast and slow directions,           |
+------------------------------------+----------+----------+------+----------------+ respectively                                                    |
| Grid-jLength                       | 0x8047   | y        | i    |                |                                                                 |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Lineend                            | 0x8048   | n [3]_   | str  | See footnote   | Type of TimingSettings                                          |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Scanrate-Frequency                 | 0x8049   | y/n [3]_ | d    |                | Scanrate of a whole trace and retrace including the overscan    |
|                                    |          |          |      |                | defined by dutyCycle                                            |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Scanrate-Dutycycle                 | 0x804A   | y/n [3]_ | d    |                |                                                                 |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Motion                             | 0x804B   | n        | str  | 'topDown'      | 'topDown' means that the scan was taken in the direction of     |
|                                    |          |          |      | 'bottomUp'     | increasing jIndex; 'bottomUp' means jIndex was decreasing.      |
|                                    |          |          |      |                | Please note that the names do not agree with the way that       |
|                                    |          |          |      |                | images are drawn in the GUI!                                    |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Scanline-Start                     | 0x804C   | i        |      |                | Reserved                                                        |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Scanline-Size                      | 0x804D   | i        |      |                | Reserved                                                        |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Delay                              | 0x804E   | n        | d    |                | Delay of TimingSettings [in seconds]                            |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| ForceSettings-Name                 | 0x8050   | y/n [2]_ | str  |                |                                                                 |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| K-Length                           | 0x8051   | y/n [2]_ |      |                |                                                                 |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Feedback-Mode                      | 0x8052   | y/n [2]_ |      |                |                                                                 |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Z-Start                            | 0x8053   | y/n [2]_ | d    |                |                                                                 |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Z-End                              | 0x8054   | y/n [2]_ | d    |                |                                                                 |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Setpoint                           | 0x8055   | y/n [2]_ | d    |                |                                                                 |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| PauseAtEnd                         | 0x8056   | y/n [3]_ | d    |                | Describes ForceTimingsettings                                   |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| PauseAtStart                       | 0x8057   | y/n [3]_ | d    |                | Describes ForceTimingsettings                                   |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| PauseOnTipsaver                    | 0x8058   | y/n [3]_ | d    |                | Describes ForceTimingsettings                                   |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| TraceScanTime                      | 0x8059   | y/n [3]_ | d    |                | Describes ForceTimingsettings                                   |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| RetraceScanTime                    | 0x805A   | y/n [3]_ | d    |                | Describes ForceTimingsettings                                   |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Z-Start-Pause-Option               | 0x805B   | n        | str  | 'constant-     | Describes the ForceScanningPauseOption                          |
|                                    |          |          |      | Height'        |                                                                 |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Z-End-Pause-Option                 | 0x805C   | n        | str  | 'constant-     | Describes the ForceScanningPauseOption                          |
|                                    |          |          |      | Height'        |                                                                 |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Tipsaver-Pause-Option              | 0x805D   | n        | str  | 'constant-     | Describes the ForceScanningPauseOption                          |
|                                    |          |          |      | Height'        |                                                                 |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| PauseBeforeFirst                   | 0x805E   | y/n [3]_ | d    |                | Describes ForceTimingSettings                                   |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Scanner                            | 0x8060   | n        | i    | Default: 0     | Stage used for x/y scanning. 0 designates the tip scanner.      |
|                                    |          |          |      |                | Deprecated starting in version 0.9, replaced by                 |
|                                    |          |          |      |                | ScannerPositions                                                |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| FitAlgorithmName                   | 0x8061   | n        | str  | 'SimpleForce-  | Describes the ForceScanFitAlgorithm used to fit this data       |
|                                    |          |          |      | ScanFit-       | (this option is only used in force map images)                  |
|                                    |          |          |      | Algorithm-     |                                                                 |
|                                    |          |          |      | ("height")'    |                                                                 |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| LastIndex                          | 0x8062   |          |      |                | [Obsolete] The last index (Nx Ã— Ny - 1) of the grid             |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| BackAndForth                       | 0x8063   | n        | bool |                | The direction the grid is organized.                            |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| ForceSettings as Properties        | 0x8064   | n        | str  |                | Contains the textual representation of the force-distance       |
|                                    |          |          |      |                | -settings. Format is as specified in the java.util.Properties   |
|                                    |          |          |      |                | object                                                          |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| NrOfSlots                          | 0x8080   | y/n [1]_ | i    |                | FeedbackModeInfo: Number of CalibrationSlots that are stored in |
|                                    |          |          |      |                | the CalibrationSet                                              |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| DefaultSlot                        | 0x8081   | y/n [1]_ | str  |                | FeedbackModeInfo: The name of the calibration slot that was     |
|                                    |          |          |      |                | selected                                                        |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Slot-Name                          | 0x8090   | y/n [1]_ | str  | 'raw' 'volts'  | FeedbackModeInfo: Name of this CalibrationSlot                  |
|                                    | + n*0x30 |          |      | etc.           |                                                                 |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Slot-Type                          | 0x8091   | y/n [1]_ | str  | 'Absolute-     | FeedbackModeInfo: Type of the current CalibrationSlot.  If the  |
|                                    | + n*0x30 |          |      | Calibration'   | type is relative, Slot-Parent must be defined.                  |
|                                    |          |          |      | 'Relative      | NB: Slot type and parent slot are not relevant when reading and |
|                                    |          |          |      | Calibration'   | interpreting image data. Just use the scaling (0x80A4/0x80A4)   |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Slot-Parent                        | 0x8092   | y/n [1]_ | str  | 'raw' 'volts'  | FeedbackModeInfo: Defines the CalibrationSlot that is the base  |
|                                    | + n*0x30 |          |      | etc.           | for current CalibrationSlot                                     |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Calibration-Name                   | 0x80A0   | y/n [1]_ | str  | Default:       | FeedbackModeInfo: Name of the calibration that contains the     |
|                                    | + n*0x30 |          |      | 'unknown -     | used encoder                                                    |
|                                    |          |          |      | Calibration'   |                                                                 |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Encoder-Name                       | 0x80A1   | y/n [1]_ | str  | 'SignedShort'  | FeedbackModeInfo: Name of the encoder that defines the scaling  |
|                                    | + n*0x30 |          |      |                | for imagedata, e.g. 'UnsignedShort'                             |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Encoder-Unit                       | 0x80A2   | y/n [1]_ | str  | 'V/m' 'N' etc. | FeedbackModeInfo: Physical unit of the scan data                |
|                                    | + n*0x30 |          |      |                |                                                                 |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Scaling-Type                       | 0x80A3   | y/n [1]_ | str  | 'LinearScaling'| FeedbackModeInfo: Type of the scaling: This defines how the     |
|                                    | + n*0x30 |          |      |                | imagedata have to be interpreted                                |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Scaling-Var[1;5]                   | [0x80A4; | y/n [1]_ |varies|                | FeedbackModeInfo: Encoder-specific parameters.  The information |
|                                    | 0x80A8]  |          |      |                | stored in these variables depends on Scaling-Type               |
|                                    | + n*0x30 |          |      |                |                                                                 |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+
| Scaling-Multiply                   | 0x80A4   | y/n [1]_ | d    |                | Only for LinearScaling: The data in this slot are given by a    |
|                                    | + n*0x30 |          |      |                | linear scaling from the raw data using                          |
+------------------------------------+----------+----------+------+----------------+                                                                 |
| Scaling-Offset                     | 0x80A5   | y/n [1]_ | d    |                | ''value = Scaling-Offset + Scaling-Multiply * raw''             |
|                                    | + n*0x30 |          |      |                |                                                                 |
+------------------------------------+----------+----------+------+----------------+-----------------------------------------------------------------+

.. [1] ``FeedbackModeInfo``: These fields describe the scalings for
   the feedback channel.  See the next section for information about
   how to interpret and use ``Scalings``.  If the ``CalibrationSet``
   for ``FeedbackModeInfo`` is saved, all data that are related to
   this ``CalibrationSet`` are required, otherwise not.
   ``Feedback_Setpoint`` is saved in unit of ``CalibrationSlot``
   "volts".  If the user wants the setpoint in other units, the value
   of ``Feedback_Setpoint`` has to be encoded in the "volts" slot then
   decoded in the selected slot.

.. [2] ``ForceSettings``: This information describes the force
   settings used when taking a force map.  It must be present for an
   image generated from a force map; otherwise it is absent.

.. [3] If the file is a normal image scan, then the ``TimingSettings``
   parameters describe the timing for the fast scanning direction.  In
   this case ``LineEnd`` will be either "lineend-pause",
   "lineend-cubic", or "lineend-quintic".  If the file is an image
   from a force map, then the ``TimingSettings`` parameters describe
   ``PauseTimingSettings`` for the individual force scans.  In this
   case, ``LineEnd`` will be either "lineend-pause" or "force-pause".
   If ``LineEnd`` is "lineend-pause", then only ``frequency`` and
   ``pauseAtEnd`` are used; the other parameters are determined as
   follows:

     ``traceScanTime`` = ``retraceScanTime`` = 0.5 * (1/``frequency``
     - ``pauseAtEnd``)

     ``pauseAtStart`` = ``pauseAtTipsaver`` = 0

   If ``LineEnd`` is "force-pause", then ``frequency`` and
   ``dutyCycle`` are unused and the parameters are read directly from
   ``traceScanTime``, ``retraceScanTime``, ``pauseAtStart``,
   ``pauseAtEnd``, and ``pauseAtTipsaver``.


------------
Channel Data
------------

Subsequent IFDs contain channel data and additional, channel-specific
information needed to interpret the data.  The following table
describes the tags that are in these IFDs.

Image data for each channel is always stored as integers.
For data recorded with a Vortis controller, the format is signed integers;
i.e., 32-bit integers from -0x80000000 through 0x7fffffff (-2147483648 â€“
2147483647).
For data from a NanoWizard I or II controller, the format is unsigned short
integers, i.e. 16-bit integers.

The conversion from integers to floating-point
physical quantities with units is done with the help of "Scalings".  A
Scaling describes how to convert the short integers that are stored in
the TIFF file into physical quantities; for example, to convert the
vertical deflection channel from an integer value into a distance in
meters.  Standard MKS units (meters, kilograms, seconds, etc.) are
used for all quantities, with no prefixes (e.g., force values are
always stored as newtons, not piconewtons).  Currently only two
scaling types are used, ``LinearScaling`` and ``NullScaling``.

For LinearScaling, quantities are scaled linearly according to the
formula

  result = offset + multiplier * value

, where offset and multiplier are the parameters of the ``LinearScaling``,
value is the input value, and result is the output value.

For ``NullScaling``, the short values are taken literally as the value
of the data; i.e., a ``NullScaling`` is equivalent to a
``LinearScaling`` with offset=0 and multiplier=1.

A channel is allowed to have multiple ``Scalings`` associated with it;
for example, if the sensitivity and the spring constant are known,
then it is possible to interpret the vertical deflection as a voltage
(the one measured internally in the instrument), as a distance, or as
a force.  Each ``Scaling`` is stored in a named "calibration slot";
for example the slots in the above example would be "volts",
"distance" and "force".  The number of calibration slots that are
available for a channel is stored in the ``NrOfSlots`` tag.  The
information for each slot is stored in a block of tags; the zeroth one
starts at 0x8090; the first one at 0x80c0, etc. and the last one at
0x8090 + (NrOfSlots - 1) * 0x30.

The calibration slot that was selected in the GUI at the time a scan
was taken is called the "default calibration slot".  Usually the
default calibration slot should be used to display the data after it
is loaded from the file, because that is the one that was in use when
the data were taken.  The name of the default calibration slot is
stored in this IFD in the ``DefaultSlot`` tag and the associated
``Scaling`` can be found by looking for the slot with the
corresponding ``Slot-Name``.


+------------------------------------+----------+----------+------+-----------------+-----------------------------------------------------------------+
| Name                               | Tag      | Required | Type | Range, example  | Description                                                     |
+====================================+==========+==========+======+=================+=================================================================+
| Channel                            | 0x8050   | y        | str  |                 | Name of the channel, e.g. height                                |
+------------------------------------+----------+----------+------+-----------------+-----------------------------------------------------------------+
| Channel-retrace                    | 0x8051   | y        | bool |                 | Direction of measurement; 0 for trace, 1 for retrace            |
+------------------------------------+----------+----------+------+-----------------+-----------------------------------------------------------------+
| ChannelFancyName                   | 0x8052   | n        | str  |                 | Easy-to-read name for this channel                              |
+------------------------------------+----------+----------+------+-----------------+-----------------------------------------------------------------+
| ChannelStyle                       | 0x8053   | n        | str  |                 | The ChannelStyle object as properties                           |
+------------------------------------+----------+----------+------+-----------------+-----------------------------------------------------------------+
| Calibration_age                    | 0x8060   | n        | str  |                 | Is given in days since the selected calibration.                |
+------------------------------------+----------+----------+------+-----------------+-----------------------------------------------------------------+
| Calibration_operator               | 0x8061   | n        | str  |                 | It is an element for later extensions (e.g. comments to own     |
|                                    |          |          |      |                 | calibration standards)                                          |
+------------------------------------+----------+----------+------+-----------------+-----------------------------------------------------------------+
| NrOfSlots                          | 0x8080   | y        | i    |                 | Number of CalibrationSlots stored in the CalibrationSet.        |
+------------------------------------+----------+----------+------+-----------------+-----------------------------------------------------------------+
| DefaultSlot                        | 0x8081   | y        | str  |                 | Indicates the Slot(name), which is selected                     |
+------------------------------------+----------+----------+------+-----------------+-----------------------------------------------------------------+
| Slot-Name                          | 0x8090   | y        | str  | 'raw'           | Name of the current CalibrationSlot                             |
|                                    | + n*0x30 |          |      |                 |                                                                 |
+------------------------------------+----------+----------+------+-----------------+-----------------------------------------------------------------+
| Slot-Type                          | 0x8091   | y        | str  | 'absolute'      | Type of the current CalibrationSlot; it may be absolute or      |
|                                    | + n*0x30 |          |      | 'relative'      | relative.  If the type is relative, then Slot-Parent must be    |
|                                    |          |          |      |                 | defined.                                                        |
|                                    |          |          |      |                 | NB: Slot type and parent slot are not relevant when reading and |
|                                    |          |          |      |                 | interpreting image data. Just use the scaling (0x80A4/0x80A4)   |
+------------------------------------+----------+----------+------+-----------------+-----------------------------------------------------------------+
| Slot-Parent                        | 0x8092   | y        | str  |                 | Defines the CalibrationSlot relative to which this slot was     |
|                                    | + n*0x30 |          |      |                 | defined                                                         |
+------------------------------------+----------+----------+------+-----------------+-----------------------------------------------------------------+
| Calibration-Name                   | 0x80A0   | y        | str  | Default:        | Name of the calibration that contains the used encoder          |
|                                    | + n*0x30 |          |      | 'unknown -      |                                                                 |
|                                    |          |          |      | Calibration'    |                                                                 |
+------------------------------------+----------+----------+------+-----------------+-----------------------------------------------------------------+
| Encoder-Name                       | 0x80A1   | y        | str  | 'UnsignedShort' | The type of data stored in the image.                           |
|                                    | + n*0x30 |          |      | 'SignedInteger' | Currently this is one of 'UnsignedShort', 'SignedInteger',      |
|                                    |          |          |      |                 | 'UnsignedShortWithValidity', 'SignedIntegerWithValidity'.       |
+------------------------------------+----------+----------+------+-----------------+-----------------------------------------------------------------+
| Encoder-Unit                       | 0x80A2   | y        | str  | e.g., 'V' 'V/m' | The physical units of the data if decoded using this Scaling.   |
|                                    | + n*0x30 |          |      |                 |                                                                 |
+------------------------------------+----------+----------+------+-----------------+-----------------------------------------------------------------+
| Scaling-Type                       | 0x80A3   | y        | str  | 'LinearScaling' | Type of the scaling: This defines how to convert from image     |
|                                    | + n*0x30 |          |      | 'NullScaling'   | data to physical quantities.  Currently this is always          |
|                                    |          |          |      |                 | 'LinearScaling' or 'NullScaling'                                |
+------------------------------------+----------+----------+------+-----------------+-----------------------------------------------------------------+
| Scaling-Var[1;5]                   | [0x80A4; | n        |      | varies          | Parameters of the Scaling; these depend on what type of Scaling |
|                                    | 0x80A8]  |          |      |                 | is used.                                                        |
|                                    | + n*0x30 |          |      |                 |                                                                 |
+------------------------------------+----------+----------+------+-----------------+-----------------------------------------------------------------+
| [unused]                           | n/a      | n/a      |      | If Scaling-Type | 'NullScaling' doesn't have any additional parameters            |
|                                    |          |          |      | is              |                                                                 |
|                                    |          |          |      | 'NullScaling'   |                                                                 |
+------------------------------------+----------+----------+------+-----------------+-----------------------------------------------------------------+
| Scaling-Multiply                   | 0x80A4   | y/n      | d    |                 | If the Encoder is 'LinearScaling', this defines the factor      |
|                                    |          |          |      | If Scaling-Type | by which the imagedata has to be multiplied                     |
+------------------------------------+----------+----------+------+ is              +-----------------------------------------------------------------+
| Scaling-Offset                     | 0x80A5   | y/n      | d    | 'LinearScaling' | If the Encoder is 'LinearScaling', this defines an offset you   |
|                                    |          |          |      |                 | have to add to the data after multiplication.                   |
+------------------------------------+----------+----------+------+-----------------+-----------------------------------------------------------------+
| Has-Invalid-Pixels                 | 0x80A9   | y        | bool |                 | 0 if this channel image is complete and has only valid pixels,  |
|                                    | + n*0x30 |          |      |                 | 1 otherwise.                                                    |
|                                    |          |          |      |                 | Readers can rely on validity of all pixels if this is 0.        |
|                                    |          |          |      |                 | Writers must set this to 1 unless they are sure that all        |
|                                    |          |          |      |                 | pixels are valid.                                               |
+------------------------------------+----------+----------+------+-----------------+-----------------------------------------------------------------+
| NaN-Marker                         | 0x80AA   | n        | i    | e.g. 0xffff,    | Encoded value used to mark up an invalid pixel for the          |
|                                    | + n*0x30 |          |      | 0x7fff_ffff     | 'WithValidity' encoders.                                        |
|                                    |          |          |      |                 | This field's value is either 0xffff for the unsigned-short      |
|                                    |          |          |      |                 | encoder, or 0x7fff_ffff for the signed-integer encoder. Other   |
|                                    |          |          |      |                 | values are unlikely to ever occur.                              |
+------------------------------------+----------+----------+------+-----------------+-----------------------------------------------------------------+
| OperationProcessDescription        | 0x80AB   | n        | str  |                 | Describes operation process                                     |
|                                    |          |          |      |                 |                                                                 |
|                                    |          |          |      |                 |                                                                 |
|                                    |          |          |      |                 |                                                                 |
|                                    |          |          |      |                 |                                                                 |
+------------------------------------+----------+----------+------+-----------------+-----------------------------------------------------------------+




To determine the calibration settings as set by the GUI, you need to
compare the ``Scalings`` for the two slots that are connected by that
calibration.  For example, the spring constant is the multiplier used
to convert the vertical deflection from "distance" to "force".
Therefore it can be determined by dividing the ``Scaling-Multiply``
for the "force" slot by the ``Scaling-Multiply`` for the "distance"
slot.

Technical note: the ``Scaling`` that is stored in the TIFF files is
the complete scaling for that calibration slot (e.g.,
``encoderSet.getScaling(slot)``); it is not the scaling relative to
the base slot (i.e., it is not
``encoderSet.getConversionSet().getConversion(slot).getScaling()``).
It is possible to derive the latter from the former, provided both
calibration slots are defined, by using
``Scaling.divide(derivedScaling, parentScaling)``.


-------------------
Further information
-------------------

If you have any questions about the JPK BioAFM image file format,
please contact `JPK BioAFM Business`_ for further information.

.. _JPK BioAFM Business: support@jpk.com